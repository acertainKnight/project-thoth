# ==============================================================================
# Thoth AI Research Assistant - Development Configuration
# 
# Two deployment modes available:
#
# 1. LOCAL MODE (default):
#    docker compose up
#    - Runs thoth-all-in-one container (API, MCP, Discovery, PDF Monitor)
#    - 3 containers total (thoth-all-in-one, letta, postgres)
#    - Lower resource usage (~3.5GB RAM)
#    - Faster startup (~30s)
#
# 2. MICROSERVICES MODE (advanced):
#    docker compose --profile microservices up
#    - Runs each service in separate containers
#    - 6 containers total (api, mcp, discovery, pdf-monitor, letta, postgres)
#    - Better for debugging individual services
#    - Higher resource usage (~4.5GB RAM)
#
# ==============================================================================

version: '3.8'

services:
  # ==============================================================================
  # Infrastructure Services
  # ==============================================================================
  # NOTE: Letta services are now external (docker-compose.letta.yml)
  # Start Letta first: docker compose -f docker-compose.letta.yml up -d
  # Or use: make letta-start
  # ==============================================================================

  # PostgreSQL Database for Letta Memory System - EXTERNAL (optional fallback)
  # This service is commented out by default. Use standalone Letta instead.
  # Only uncomment if you need a separate dev Letta for testing.
  #
  # letta-postgres:
  #   profiles: ["dev-letta"]  # Only start with --profile dev-letta
  #   image: ankane/pgvector:latest
  #   container_name: thoth-dev-letta-postgres
  #   environment:
  #     - POSTGRES_DB=letta
  #     - POSTGRES_USER=letta
  #     - POSTGRES_PASSWORD=letta_dev_password
  #     - POSTGRES_INITDB_ARGS=--encoding=UTF-8
  #   volumes:
  #     - thoth-dev-letta-postgres:/var/lib/postgresql/data
  #     - ./docker/init-pgvector.sh:/docker-entrypoint-initdb.d/init-pgvector.sh:ro
  #   ports:
  #     - "5433:5432"  # Different port to avoid conflict with standalone
  #   networks:
  #     - thoth-dev-network
  #     - letta-network  # Connect to standalone Letta network
  #   restart: unless-stopped
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U letta -d letta"]
  #     interval: 15s
  #     timeout: 5s
  #     retries: 3
  #     start_period: 30s



  # ==============================================================================
  # Thoth Services
  # ==============================================================================
  # By default, runs thoth-all-in-one (local mode)
  # Use --profile microservices for separate services
  # ==============================================================================

  # ==============================================================================
  # Thoth All-in-One Container (DEFAULT - Local Mode)
  # ==============================================================================
  thoth-all-in-one:
    profiles: ["standalone"]  # Only start without microservices profile
    build:
      context: .
      dockerfile: docker/all-in-one/Dockerfile
      # target: development  # Not using multi-stage build
    container_name: thoth-dev-all-in-one
    user: "1000:1000"
    env_file:
      - .env
    environment:
      # Vault configuration
      - OBSIDIAN_VAULT_PATH=/vault
      - THOTH_SETTINGS_FILE=/vault/_thoth/settings.json

      # Service discovery - Use EXTERNAL Letta (standalone)
      - THOTH_LETTA_URL=http://letta-server:8283
      - DATABASE_URL=postgresql://thoth:thoth_password@letta-postgres:5432/thoth

      # Development settings
      - THOTH_LOG_LEVEL=DEBUG
      - THOTH_HOT_RELOAD=1
      - DOCKER_ENV=true

      # API Keys
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - API_MISTRAL_KEY=${API_MISTRAL_KEY:-}
      - API_OPENROUTER_KEY=${API_OPENROUTER_KEY:-}
      - API_SEMANTIC_SCHOLAR_KEY=${API_SEMANTIC_SCHOLAR_KEY:-}
      - API_WEB_SEARCH_KEY=${API_WEB_SEARCH_KEY:-}
    volumes:
      - ${OBSIDIAN_VAULT_PATH:-./workspace}:/vault:rw
      - ./src:/app/src:ro
      - ./data/prompts:/app/prompts:ro
    ports:
      - "8000:8000"  # API
      - "8082:8000"  # MCP (HTTP transport includes /mcp and /sse endpoints)
    networks:
      - thoth-dev-network
      - letta-network  # Connect to external Letta network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ==============================================================================
  # Infrastructure Services
  # ==============================================================================
  # NOTE: Letta Memory Service is now EXTERNAL (docker-compose.letta.yml)
  # This service is commented out by default. Use standalone Letta instead.
  # Only uncomment if you need a separate dev Letta for testing.
  # ==============================================================================

  # Letta Memory Service - EXTERNAL (optional fallback)
  # letta:
  #   profiles: ["dev-letta"]  # Only start with --profile dev-letta
  #   image: letta/letta:latest
  #   container_name: thoth-dev-letta
  #   environment:
  #     - LETTA_SERVER_HOST=0.0.0.0
  #     - LETTA_SERVER_PORT=8283
  #     - LETTA_PG_URI=postgresql://letta:letta_dev_password@thoth-dev-letta-postgres:5432/letta
  #
  #     # LLM Provider Configuration
  #     - OPENAI_API_KEY=${OPENAI_API_KEY:-}
  #     - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
  #     - API_MISTRAL_KEY=${API_MISTRAL_KEY:-}
  #     - OLLAMA_BASE_URL=${OLLAMA_BASE_URL:-}
  #
  #     # Security Configuration
  #     - SECURE=${LETTA_SECURE:-false}
  #     - LETTA_SERVER_PASSWORD=${LETTA_SERVER_PASSWORD:-}
  #
  #     # Tool Execution & Sandboxing
  #     - E2B_API_KEY=${E2B_API_KEY:-}
  #     - E2B_SANDBOX_TEMPLATE_ID=${E2B_SANDBOX_TEMPLATE_ID:-}
  #     - TOOL_EXEC_DIR=/workspace/tools
  #
  #     # Logging
  #     - LETTA_LOG_LEVEL=DEBUG
  #   volumes:
  #     - thoth-dev-letta-data:/var/lib/postgresql/data
  #     - ./workspace:/workspace  # For tool execution and shared data
  #   ports:
  #     - "8284:8283"  # Different port to avoid conflict
  #   networks:
  #     - thoth-dev-network
  #     - letta-network  # Connect to standalone Letta network
  #   depends_on:
  #     letta-postgres:
  #       condition: service_healthy
  #   restart: unless-stopped
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:8283/v1/health"]
  #     interval: 15s
  #     timeout: 5s
  #     retries: 3
  #     start_period: 60s

  # ==============================================================================
  # Microservices Mode (use --profile microservices)
  # ==============================================================================

  # Main API Server
  thoth-api:
    profiles: ["microservices"]
    build:
      context: .
      dockerfile: Dockerfile
      # target: development  # Not using multi-stage build
      args:
        SERVICE_EXTRAS: "service-api"  # Includes api,discovery,pdf,langchain,vectordb,memory
    container_name: thoth-dev-api
    user: "1000:1000"  # Run as host user for proper file permissions
    env_file:
      - .env
    environment:
      # =============================================================================
      # SIMPLIFIED CONFIGURATION - All paths loaded from settings.json via config.py
      # =============================================================================
      # Previously had 40+ environment variables that duplicated settings.json.
      # Removed: LETTA_DIR, LETTA_LOGS_DIR, LETTA_CACHE_DIR, LETTA_CONFIG_DIR
      #          and other path-related variables that are now managed by config.py
      # =============================================================================

      # Vault configuration (REQUIRED - tells config.py where to find settings)
      - OBSIDIAN_VAULT_PATH=/vault
      - THOTH_SETTINGS_FILE=/vault/_thoth/settings.json

      # Service discovery (REQUIRED - inter-service communication URLs)
      - THOTH_LETTA_URL=http://letta-server:8283
      - THOTH_MCP_URL=http://thoth-mcp:8000
      - THOTH_DISCOVERY_URL=http://thoth-discovery:8004
      - DATABASE_URL=postgresql://thoth:thoth_password@letta-postgres:5432/thoth

      # Development settings (REQUIRED - dev-specific configuration)
      - THOTH_LOG_LEVEL=DEBUG
      - THOTH_DEV_MODE=1

      # Hot-reload configuration
      # Automatically reload when vault/_thoth/settings.json changes
      # No container restart needed!
      - THOTH_HOT_RELOAD=1
      - DOCKER_ENV=true

      # API Keys (REQUIRED - loaded from .env file)
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - API_MISTRAL_KEY=${API_MISTRAL_KEY:-}
      - API_OPENROUTER_KEY=${API_OPENROUTER_KEY:-}
      - API_SEMANTIC_SCHOLAR_KEY=${API_SEMANTIC_SCHOLAR_KEY:-}
    volumes:
      - ${OBSIDIAN_VAULT_PATH:-./workspace}:/vault:rw  # Mount entire vault
      - ./src:/app/src:ro  # Mount source for development
      - ./data/prompts:/app/prompts:ro  # System prompts
    ports:
      - "8000:8000"
    networks:
      - thoth-dev-network
      - letta-network  # Connect to external Letta network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "http://localhost:8000/health"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 60s

  # MCP Server (Model Context Protocol)
  thoth-mcp:
    profiles: ["microservices"]
    build:
      context: .
      dockerfile: Dockerfile
      # target: development  # Not using multi-stage build
      args:
        SERVICE_EXTRAS: "service-mcp"  # Includes api,pdf,mcp,discovery,langchain,vectordb,embeddings,memory
    container_name: thoth-dev-mcp
    user: "1000:1000"  # Run as host user for proper file permissions
    env_file:
      - .env
    environment:
      # =============================================================================
      # SIMPLIFIED CONFIGURATION - All paths loaded from settings.json via config.py
      # =============================================================================
      # Previously had 40+ environment variables that duplicated settings.json.
      # Removed: LETTA_DIR, LETTA_LOGS_DIR, LETTA_CACHE_DIR, LETTA_CONFIG_DIR,
      #          HOME, THOTH_MCP_HOST, THOTH_MCP_PORT (defaults handled by config.py)
      # =============================================================================

      # Vault configuration (REQUIRED - tells config.py where to find settings)
      - OBSIDIAN_VAULT_PATH=/vault
      - THOTH_SETTINGS_FILE=/vault/_thoth/settings.json

      # Service discovery (REQUIRED - inter-service communication URLs)
      - THOTH_LETTA_URL=http://letta-server:8283
      - THOTH_API_URL=http://thoth-api:8000
      - DATABASE_URL=postgresql://thoth:thoth_password@letta-postgres:5432/thoth

      # Development settings (REQUIRED - dev-specific configuration)
      - THOTH_LOG_LEVEL=DEBUG

      # Hot-reload configuration
      # Automatically reload when vault/_thoth/settings.json changes
      # No container restart needed!
      - THOTH_HOT_RELOAD=1
      - DOCKER_ENV=true

      # API Keys (REQUIRED - loaded from .env file)
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
    volumes:
      - ${OBSIDIAN_VAULT_PATH:-./workspace}:/vault:rw  # Mount entire vault
      - ./src:/app/src:ro  # Mount source for development
    ports:
      - "8082:8000"  # HTTP transport (includes /mcp and /sse endpoints)
    networks:
      - thoth-dev-network
      - letta-network  # Connect to external Letta network
    depends_on:
      thoth-api:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 30s

  # Discovery Service
  thoth-discovery:
    profiles: ["microservices"]
    build:
      context: .
      dockerfile: Dockerfile
      # target: development  # Not using multi-stage build
      args:
        SERVICE_EXTRAS: "service-discovery"  # Includes api,discovery,pdf,langchain,vectordb
    container_name: thoth-dev-discovery
    user: "1000:1000"  # Run as host user for proper file permissions
    env_file:
      - .env
    environment:
      # =============================================================================
      # SIMPLIFIED CONFIGURATION - All paths loaded from settings.json via config.py
      # =============================================================================
      # Previously had 40+ environment variables that duplicated settings.json.
      # Removed: LETTA_DIR, LETTA_LOGS_DIR, LETTA_CACHE_DIR, LETTA_CONFIG_DIR,
      #          HOME, THOTH_DISCOVERY_HOST, THOTH_DISCOVERY_PORT (defaults in config.py)
      #          THOTH_DISCOVERY_CHECK_INTERVAL (loaded from settings.json)
      # =============================================================================

      # Vault configuration (REQUIRED - tells config.py where to find settings)
      - OBSIDIAN_VAULT_PATH=/vault
      - THOTH_SETTINGS_FILE=/vault/_thoth/settings.json

      # Service discovery (REQUIRED - inter-service communication URLs)
      - THOTH_API_URL=http://thoth-api:8000
      - DATABASE_URL=postgresql://thoth:thoth_password@letta-postgres:5432/thoth

      # Development settings (REQUIRED - dev-specific configuration)
      - THOTH_LOG_LEVEL=DEBUG

      # Hot-reload configuration
      # Automatically reload when vault/_thoth/settings.json changes
      # No container restart needed!
      - THOTH_HOT_RELOAD=1
      - DOCKER_ENV=true

      # Discovery settings (REQUIRED - service-specific overrides)
      - THOTH_DISCOVERY_AUTO_START_SCHEDULER=true
      - THOTH_DISCOVERY_DEFAULT_MAX_ARTICLES=50

      # API Keys (REQUIRED - loaded from .env file)
      - API_SEMANTIC_SCHOLAR_KEY=${API_SEMANTIC_SCHOLAR_KEY:-}
      - API_WEB_SEARCH_KEY=${API_WEB_SEARCH_KEY:-}
    volumes:
      - ${OBSIDIAN_VAULT_PATH:-./workspace}:/vault:rw  # Mount entire vault
      - ./src:/app/src:ro  # Mount source for development
    ports:
      - "8004:8004"
    networks:
      - thoth-dev-network
      - letta-network  # Connect to external Letta network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8004/health"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 30s

  # PDF Monitor Service
  thoth-pdf-monitor:
    profiles: ["microservices"]
    build:
      context: .
      dockerfile: Dockerfile
      # target: development  # Not using multi-stage build
      args:
        SERVICE_EXTRAS: "service-monitor"  # Includes api,pdf,discovery,mcp,langchain,vectordb,embeddings
    container_name: thoth-dev-pdf-monitor
    user: "1000:1000"  # Run as host user for proper file permissions
    command: ["python", "-m", "thoth", "monitor"]
    env_file:
      - .env
    environment:
      # =============================================================================
      # SIMPLIFIED CONFIGURATION - All paths loaded from settings.json via config.py
      # =============================================================================
      # Previously had 40+ environment variables that duplicated settings.json.
      # Removed: LETTA_DIR, LETTA_LOGS_DIR, LETTA_CACHE_DIR, LETTA_CONFIG_DIR,
      #          HOME (all path-related variables now managed by config.py)
      # =============================================================================

      # Vault configuration (REQUIRED - tells config.py where to find settings)
      - OBSIDIAN_VAULT_PATH=/vault
      - THOTH_SETTINGS_FILE=/vault/_thoth/settings.json

      # Service discovery (REQUIRED - inter-service communication URLs)
      - THOTH_API_URL=http://thoth-api:8000
      - DATABASE_URL=postgresql://thoth:thoth_password@letta-postgres:5432/thoth

      # Development settings (REQUIRED - dev-specific configuration)
      - THOTH_LOG_LEVEL=DEBUG

      # Hot-reload configuration
      # Automatically reload when vault/_thoth/settings.json changes
      # No container restart needed!
      - THOTH_HOT_RELOAD=1
      - DOCKER_ENV=true

      # Monitor settings (REQUIRED - service-specific configuration)
      - THOTH_PDF_MONITOR_INTERVAL=30

      # API Keys (REQUIRED - loaded from .env file)
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - API_MISTRAL_KEY=${API_MISTRAL_KEY:-}
    volumes:
      - ${OBSIDIAN_VAULT_PATH:-./workspace}:/vault:rw  # Mount entire vault
      - ./src:/app/src:ro  # Mount source for development
      - ./data/prompts:/app/prompts:ro  # System prompts
    networks:
      - thoth-dev-network
      - letta-network  # Connect to external Letta network for PostgreSQL access
    depends_on:
      thoth-api:
        condition: service_healthy
    restart: unless-stopped


  # ==============================================================================
  # Development Tools
  # ==============================================================================

  # Development proxy for easy access (optional)
  nginx-dev:
    profiles: ["microservices"]
    image: nginx:alpine
    container_name: thoth-dev-nginx
    volumes:
      - ./docker/nginx/dev.conf:/etc/nginx/nginx.conf:ro
    ports:
      - "80:80"
      - "443:443"
    networks:
      - thoth-dev-network
    depends_on:
      - thoth-api
      - thoth-mcp
      - thoth-discovery
    restart: unless-stopped

# ==============================================================================
# Development Volumes
# ==============================================================================
volumes:
  thoth-dev-letta-data:
    driver: local
    name: thoth-dev-letta-data

  thoth-dev-letta-postgres:
    driver: local
    name: thoth-dev-letta-postgres

  # NOTE: workspace is now local bind mount (./workspace)
  # See bind mount volumes in services above

# ==============================================================================
# Development Network
# ==============================================================================
networks:
  thoth-dev-network:
    driver: bridge
    name: thoth-dev-network
    ipam:
      config:
        - subnet: 172.21.0.0/16

  # External Letta network (from docker-compose.letta.yml)
  letta-network:
    external: true
    name: letta-network
