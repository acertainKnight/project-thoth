# ==============================================================================
# Thoth AI Research Assistant - Development Configuration
#
# MICROSERVICES ARCHITECTURE (use --profile microservices):
#    - Runs each service in separate containers
#    - Hot-reload enabled via source mounting
#    - Debug logging and development tools
#    - 5 containers: api, mcp, monitor, dashboard, discovery
#
# Example: docker compose -f docker-compose.dev.yml --profile microservices up -d
#
# ==============================================================================

services:
  # ==============================================================================
  # Infrastructure Services
  # ==============================================================================
  # NOTE: Letta services are now external (docker-compose.letta.yml)
  # Start Letta first: docker compose -f docker-compose.letta.yml up -d
  # Or use: make letta-start
  # ==============================================================================

  # PostgreSQL Database for Letta Memory System - EXTERNAL (optional fallback)
  thoth-api:
    profiles: ["microservices"]
    build:
      context: .
      dockerfile: Dockerfile
      # target: development  # Not using multi-stage build
      args:
        SERVICE_EXTRAS: "service-api"  # Includes api,discovery,pdf,langchain,vectordb,memory
    container_name: thoth-dev-api
    user: "1000:1000"  # Run as host user for proper file permissions
    env_file:
      - .env
    environment:
      # =============================================================================
      # SIMPLIFIED CONFIGURATION - All paths loaded from settings.json via config.py
      # =============================================================================
      # Previously had 40+ environment variables that duplicated settings.json.
      # Removed: LETTA_DIR, LETTA_LOGS_DIR, LETTA_CACHE_DIR, LETTA_CONFIG_DIR
      #          and other path-related variables that are now managed by config.py
      # =============================================================================

      # Prioritize mounted source over installed package for hot-reload
      - PYTHONPATH=/app/src

      # Playwright browsers path (writable by thoth user)
      - PLAYWRIGHT_BROWSERS_PATH=/app/.cache/ms-playwright

      # Vault configuration (REQUIRED - tells config.py where to find settings)
      - OBSIDIAN_VAULT_PATH=/vault
      - THOTH_SETTINGS_FILE=/vault/thoth/_thoth/settings.json

      # Service discovery (REQUIRED - inter-service communication URLs)
      - THOTH_LETTA_URL=http://letta-server:8283
      - THOTH_MCP_URL=http://thoth-mcp:8001
      - THOTH_DISCOVERY_URL=http://thoth-discovery:8004
      - DATABASE_URL=postgresql://thoth:thoth_password@letta-postgres:5432/thoth

      # Development settings (REQUIRED - dev-specific configuration)
      - THOTH_LOG_LEVEL=DEBUG
      - THOTH_DEV_MODE=1

      # Hot-reload configuration
      # Automatically reload when vault/thoth/_thoth/settings.json changes
      # No container restart needed!
      - THOTH_HOT_RELOAD=1
      - DOCKER_ENV=true

      # API Keys (REQUIRED - loaded from .env file)
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - API_MISTRAL_KEY=${API_MISTRAL_KEY:-}
      - API_OPENROUTER_KEY=${API_OPENROUTER_KEY:-}
      - API_SEMANTIC_SCHOLAR_KEY=${API_SEMANTIC_SCHOLAR_KEY:-}
    volumes:
      - ${OBSIDIAN_VAULT_PATH:-./workspace}:/vault:rw  # Mount entire vault
      - ./src:/app/src:ro  # Mount source for development
    ports:
      - "8000:8000"
    networks:
      - thoth-dev-network
      - letta-network  # Connect to external Letta network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "http://localhost:8000/health"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 60s

  # MCP Server (Model Context Protocol)
  thoth-mcp:
    profiles: ["microservices"]
    build:
      context: .
      dockerfile: docker/mcp/Dockerfile
      target: development
      args:
        SERVICE_EXTRAS: "service-mcp"
    container_name: thoth-dev-mcp
    command: ["python", "-m", "thoth", "mcp", "http", "--host", "0.0.0.0", "--port", "8001", "--log-level", "DEBUG"]
    user: "1000:1000"  # Run as host user for proper file permissions
    env_file:
      - .env
    environment:
      # =============================================================================
      # SIMPLIFIED CONFIGURATION - All paths loaded from settings.json via config.py
      # =============================================================================
      # Previously had 40+ environment variables that duplicated settings.json.
      # Removed: LETTA_DIR, LETTA_LOGS_DIR, LETTA_CACHE_DIR, LETTA_CONFIG_DIR,
      #          HOME, THOTH_MCP_HOST, THOTH_MCP_PORT (defaults handled by config.py)
      # =============================================================================

      # Vault configuration (REQUIRED - tells config.py where to find settings)
      - OBSIDIAN_VAULT_PATH=/vault
      - THOTH_SETTINGS_FILE=/vault/thoth/_thoth/settings.json

      # Service discovery (REQUIRED - inter-service communication URLs)
      - THOTH_LETTA_URL=http://letta-server:8283
      - THOTH_API_URL=http://thoth-api:8000
      - DATABASE_URL=postgresql://thoth:thoth_password@letta-postgres:5432/thoth

      # Development settings (REQUIRED - dev-specific configuration)
      - THOTH_LOG_LEVEL=DEBUG

      # Prioritize mounted source over installed package for hot-reload
      - PYTHONPATH=/app/src:${PYTHONPATH:-}

      # Hot-reload configuration
      # Automatically reload when vault/thoth/_thoth/settings.json changes
      # No container restart needed!
      - THOTH_HOT_RELOAD=1
      - DOCKER_ENV=true

      # API Keys (REQUIRED - loaded from .env file)
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
    volumes:
      - ${OBSIDIAN_VAULT_PATH:-./workspace}:/vault:rw  # Mount entire vault
      - ./src:/app/src:ro  # Mount source for development
    ports:
      - "8082:8001"  # HTTP transport (includes /mcp and /sse endpoints)
    networks:
      - thoth-dev-network
      - letta-network  # Connect to external Letta network
    depends_on:
      thoth-api:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 60s

  # Discovery Service - Research Question Scheduler
  thoth-discovery:
    profiles: ["microservices"]
    build:
      context: .
      dockerfile: Dockerfile
      # target: development  # Not using multi-stage build
      args:
        SERVICE_EXTRAS: "service-discovery"  # Includes api,discovery,pdf,langchain,vectordb
    container_name: thoth-dev-discovery
    user: "1000:1000"  # Run as host user for proper file permissions
    command: ["python", "-m", "thoth", "research", "scheduler"]
    env_file:
      - .env
    environment:
      # Prioritize mounted source over installed package for hot-reload
      - PYTHONPATH=/app/src

      # Vault configuration (REQUIRED - tells config.py where to find settings)
      - OBSIDIAN_VAULT_PATH=/vault
      - THOTH_SETTINGS_FILE=/vault/thoth/_thoth/settings.json

      # Service discovery (REQUIRED - inter-service communication URLs)
      - THOTH_API_URL=http://thoth-api:8000
      - DATABASE_URL=postgresql://thoth:thoth_password@letta-postgres:5432/thoth

      # Development settings (REQUIRED - dev-specific configuration)
      - THOTH_LOG_LEVEL=DEBUG

      # Hot-reload configuration
      - THOTH_HOT_RELOAD=1
      - DOCKER_ENV=true

      # Playwright browser path (fixed location, independent of HOME/user)
      - PLAYWRIGHT_BROWSERS_PATH=/app/.cache/ms-playwright

      # Discovery settings (REQUIRED - service-specific overrides)
      - THOTH_DISCOVERY_AUTO_START_SCHEDULER=true
      - THOTH_DISCOVERY_DEFAULT_MAX_ARTICLES=50

      # API Keys (REQUIRED - loaded from .env file)
      - API_SEMANTIC_SCHOLAR_KEY=${API_SEMANTIC_SCHOLAR_KEY:-}
      - API_WEB_SEARCH_KEY=${API_WEB_SEARCH_KEY:-}
    volumes:
      - ${OBSIDIAN_VAULT_PATH:-./workspace}:/vault:rw  # Mount entire vault
      - ./src:/app/src:ro  # Mount source for development
    ports:
      - "8004:8000"  # Map external 8004 to internal 8000 (FastAPI default)
    networks:
      - thoth-dev-network
      - letta-network  # Connect to external Letta network
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s

  # Monitor Service (optimized PDF processing)
  thoth-monitor:
    profiles: ["microservices"]
    build:
      context: .
      dockerfile: Dockerfile
      # target: development  # Not using multi-stage build
      args:
        SERVICE_EXTRAS: "service-monitor"  # Includes api,pdf,discovery,mcp,langchain,vectordb,embeddings
    container_name: thoth-dev-pdf-monitor
    user: "1000:1000"  # Run as host user for proper file permissions
    command: ["python", "-m", "thoth.run_monitor_standalone"]
    env_file:
      - .env
    environment:
      # Prioritize mounted source over installed package for hot-reload
      - PYTHONPATH=/app/src

      # Vault configuration (REQUIRED - tells config.py where to find settings)
      - OBSIDIAN_VAULT_PATH=/vault
      - THOTH_SETTINGS_FILE=/vault/thoth/_thoth/settings.json

      # Service discovery (REQUIRED - inter-service communication URLs)
      - THOTH_API_URL=http://thoth-api:8000
      - DATABASE_URL=postgresql://thoth:thoth_password@letta-postgres:5432/thoth

      # Development settings (REQUIRED - dev-specific configuration)
      - THOTH_LOG_LEVEL=DEBUG

      # Hot-reload configuration
      - THOTH_HOT_RELOAD=1
      - DOCKER_ENV=true

      # Monitor settings (REQUIRED - service-specific configuration)
      - THOTH_PDF_MONITOR_INTERVAL=30

      # API Keys (REQUIRED - loaded from .env file)
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - API_MISTRAL_KEY=${API_MISTRAL_KEY:-}
    volumes:
      - ${OBSIDIAN_VAULT_PATH:-./workspace}:/vault:rw  # Mount entire vault
      - ./src:/app/src:ro  # Mount source for development
    networks:
      - thoth-dev-network
      - letta-network  # Connect to external Letta network for PostgreSQL access
    depends_on:
      thoth-api:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "kill -0 1"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Dashboard Service
  thoth-dashboard:
    profiles: ["microservices"]
    build:
      context: .
      dockerfile: Dockerfile
      args:
        SERVICE_EXTRAS: "service-dashboard"
    container_name: thoth-dev-dashboard
    user: "1000:1000"  # Run as host user for proper file permissions
    command: [
      "python", "-m", "thoth", "research", "start-dashboard",
      "--check-interval", "60"
    ]
    env_file:
      - .env
    environment:
      # Prioritize mounted source over installed package for hot-reload
      - PYTHONPATH=/app/src

      # Vault configuration (REQUIRED - tells config.py where to find settings)
      - OBSIDIAN_VAULT_PATH=/vault
      - THOTH_SETTINGS_FILE=/vault/thoth/_thoth/settings.json

      # Service discovery (REQUIRED - inter-service communication URLs)
      - THOTH_API_URL=http://thoth-api:8000
      - DATABASE_URL=postgresql://thoth:thoth_password@letta-postgres:5432/thoth

      # Development settings (REQUIRED - dev-specific configuration)
      - THOTH_LOG_LEVEL=DEBUG

      # Hot-reload configuration
      - THOTH_HOT_RELOAD=1
      - DOCKER_ENV=true

      # API Keys (REQUIRED - loaded from .env file)
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
    volumes:
      - ${OBSIDIAN_VAULT_PATH:-./workspace}:/vault:rw  # Mount entire vault
      - ./src:/app/src:ro  # Mount source for development
    networks:
      - thoth-dev-network
      - letta-network  # Connect to external Letta network
    depends_on:
      thoth-api:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      disable: true  # Dashboard is a background monitoring service, doesn't expose HTTP endpoints


# ==============================================================================
# Development Volumes
# ==============================================================================
volumes:
  thoth-dev-letta-data:
    driver: local
    name: thoth-dev-letta-data

  thoth-dev-letta-postgres:
    driver: local
    name: thoth-dev-letta-postgres

  # NOTE: workspace is now local bind mount (./workspace)
  # See bind mount volumes in services above

# ==============================================================================
# Development Network
# ==============================================================================
networks:
  thoth-dev-network:
    driver: bridge
    name: thoth-dev-network
    ipam:
      config:
        - subnet: 172.21.0.0/16

  # External Letta network (from docker-compose.letta.yml)
  letta-network:
    external: true
    name: letta-network
