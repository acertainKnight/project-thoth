# ==============================================================================
# Thoth AI Research Assistant - Docker Compose Override
# Local development overrides and customizations
# This file is automatically loaded by docker-compose and can be customized
# ==============================================================================

version: '3.8'

services:
  # ==============================================================================
  # Thoth App Overrides
  # UV-recommended docker compose watch for hot-reload development
  # ==============================================================================
  thoth-app:
    # Use development Dockerfile with UV best practices
    build:
      context: .
      dockerfile: Dockerfile.dev
      target: runtime  # Multi-stage build: builder -> runtime

    # Override for local development
    environment:
      # Local development settings
      - THOTH_LOG_LEVEL=DEBUG
      - THOTH_DEV_MODE=1
      # Prioritize mounted source over installed package for hot-reload
      - PYTHONPATH=/app/src:${PYTHONPATH:-}

    volumes:
      # Mount source code for hot-reload development (no rebuild needed!)
      - ./src:/app/src
      - ./pyproject.toml:/app/pyproject.toml:ro

      # Mount local configuration if it exists
      - ./config.local.yml:/app/config.local.yml:ro

    # Override port mappings for development (maintain remapping to avoid conflicts)
    ports:
      - "8080:8000"  # API server (remapped to avoid local dev conflicts)
      - "8082:8000"  # MCP server HTTP transport (includes /mcp and /sse endpoints)
      - "5678:5678"  # Debug port

    develop:
      # UV best practice: use docker compose watch
      watch:
        # Sync source code changes automatically
        - action: sync
          path: ./src
          target: /app/src

        # Rebuild on dependency changes only
        - action: rebuild
          path: ./pyproject.toml

  # ==============================================================================
  # Thoth Monitor Overrides
  # UV-recommended docker compose watch for hot-reload development
  # ==============================================================================
  thoth-monitor:
    environment:
      # Prioritize mounted source over installed package for hot-reload
      - PYTHONPATH=/app/src:${PYTHONPATH:-}
    volumes:
      # Mount source code for hot-reload development
      - ./src:/app/src
      - ./pyproject.toml:/app/pyproject.toml:ro

    develop:
      # UV best practice: use docker compose watch
      watch:
        # Sync source code changes automatically
        - action: sync
          path: ./src
          target: /app/src

        # Rebuild on dependency changes only
        - action: rebuild
          path: ./pyproject.toml

  # ==============================================================================
  # Thoth MCP Overrides
  # UV-recommended docker compose watch for hot-reload development
  # See: https://docs.astral.sh/uv/guides/integration/docker/#configuring-watch-with-docker-compose
  # ==============================================================================
  thoth-mcp:
    environment:
      # Prioritize mounted source over installed package for hot-reload
      - PYTHONPATH=/app/src:${PYTHONPATH:-}
    volumes:
      # Mount source code for hot-reload development (no rebuild needed!)
      - ./src:/app/src
      - ./pyproject.toml:/app/pyproject.toml:ro

    develop:
      # UV best practice: use docker compose watch
      watch:
        # Sync source code changes automatically
        - action: sync
          path: ./src
          target: /app/src

        # Rebuild on dependency changes only
        - action: rebuild
          path: ./pyproject.toml

  # ==============================================================================
  # Thoth API Overrides
  # UV-recommended docker compose watch for hot-reload development
  # ==============================================================================
  thoth-api:
    environment:
      # Prioritize mounted source over installed package for hot-reload
      - PYTHONPATH=/app/src:${PYTHONPATH:-}
    volumes:
      - ./src:/app/src
      - ./pyproject.toml:/app/pyproject.toml:ro

    develop:
      watch:
        - action: sync
          path: ./src
          target: /app/src
        - action: rebuild
          path: ./pyproject.toml

  # ==============================================================================
  # Thoth Discovery Overrides
  # UV-recommended docker compose watch for hot-reload development
  # ==============================================================================
  thoth-discovery:
    environment:
      # Prioritize mounted source over installed package for hot-reload
      - PYTHONPATH=/app/src:${PYTHONPATH:-}
    volumes:
      - ./src:/app/src
      - ./pyproject.toml:/app/pyproject.toml:ro

    develop:
      watch:
        - action: sync
          path: ./src
          target: /app/src
        - action: rebuild
          path: ./pyproject.toml

  # ==============================================================================
  # Thoth Dashboard Overrides
  # UV-recommended docker compose watch for hot-reload development
  # ==============================================================================
  thoth-dashboard:
    environment:
      # Prioritize mounted source over installed package for hot-reload
      - PYTHONPATH=/app/src:${PYTHONPATH:-}
    volumes:
      - ./src:/app/src
      - ./pyproject.toml:/app/pyproject.toml:ro

    develop:
      watch:
        - action: sync
          path: ./src
          target: /app/src
        - action: rebuild
          path: ./pyproject.toml
